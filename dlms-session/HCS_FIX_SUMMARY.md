# HCS (Header Check Sequence) 修复总结

## 修复完成时间
2025-01-XX

## 问题描述
根据 `dlms-docs/dlms/hdlc帧格式.txt` 文档，HDLC帧的正确结构应该包含HCS字段，但原实现中缺失。

## 修复内容

### 1. 帧结构修正
**修复前**:
```
标志 | 帧格式 | 目的地址 | 源地址 | 控制 | FCS | 信息 | FCS | 标志
```

**修复后**:
```
标志 | 帧格式 | 目的地址 | 源地址 | 控制 | HCS | 信息 | FCS | 标志
```

### 2. 修改的文件
- `dlms-session/src/hdlc/frame.rs`

### 3. 具体修改

#### encode() 方法
- ✅ 添加HCS计算（在控制域后）
- ✅ 更新FCS计算（包括HCS）
- ✅ 更新帧长度计算（包括HCS）
- ✅ 添加详细的文档注释

#### decode() 方法
- ✅ 添加HCS读取和验证
- ✅ 更新FCS验证（包括HCS）
- ✅ 修正信息域读取逻辑
- ✅ 添加详细的文档注释

#### new() 和 new_information() 方法
- ✅ 更新长度计算（包括HCS）
- ✅ 添加文档注释

## 设计决策

### 为什么需要HCS和FCS两个校验？
1. **HCS (Header Check Sequence)**: 
   - 验证帧头部（格式+地址+控制域）
   - 允许在处理信息域之前快速检测头部损坏
   - 对于大帧特别重要，可以避免不必要的处理

2. **FCS (Frame Check Sequence)**:
   - 验证整个帧（头部+HCS+信息域）
   - 提供端到端的完整性检查

### 实现细节
- HCS和FCS使用相同的CRC算法（X**0 + X**5 + X**12 + X**16）
- HCS计算范围：帧格式(2) + 目的地址 + 源地址 + 控制域(1)
- FCS计算范围：帧格式(2) + 地址 + 控制域(1) + HCS(2) + 信息域

### 优化考虑
- 复用FcsCalc进行HCS和FCS计算
- 帧长度在所有字段编码后计算，确保准确性
- 更新帧格式长度字段后，需要重新计算HCS和FCS

## 测试建议

### 单元测试
1. HCS计算正确性测试
2. HCS验证失败测试
3. FCS计算正确性测试（包括HCS）
4. 完整帧编码/解码往返测试

### 集成测试
1. 与标准DLMS设备通信测试
2. 不同地址长度组合测试
3. 有/无信息域帧测试
4. 分段帧测试

## 兼容性影响

### 破坏性变更
- ⚠️ **重要**: 此修复改变了帧结构，与旧版本不兼容
- 旧版本编码的帧无法被新版本正确解码
- 新版本编码的帧无法被旧版本正确解码

### 建议
- 如果项目中有使用旧格式的帧，需要添加版本检查或迁移逻辑
- 考虑添加配置选项以支持旧格式（如果需要向后兼容）

## 下一步
根据检查报告，还需要修复：
1. HDLC连接建立流程 (SNRM/UA握手)
2. UA帧参数解析
3. RR帧自动发送
4. DISC/DM/UA断开流程完善
